# Local development Docker setup for Sporttia ZERO
# Usage: docker compose -f docker-compose.local.yml up
#
# Prerequisites:
# - Copy .env.local.example to .env.local and fill in your API keys
# - MySQL tunnel must be running for Sporttia DB: ssh -L 3311:sporttia-sql-pre:3306 sporttia-hub
# - VPN connection for Cloud SQL PostgreSQL access
#
# Database environments (via VPN):
# - PRE: 10.63.50.7 (sporttia-hub-pre)
# - PRO: 10.63.50.5 (sporttia-hub)

services:
  # API server with hot reloading
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api.local
    container_name: sporttia-zero-api-local
    restart: unless-stopped
    ports:
      - "4500:4500"
    environment:
      - NODE_ENV=development
      - PORT=4500
      - DATABASE_URL=postgresql://sporttia:Trebujena1!@10.63.50.7:5432/sporttia_zero?sslmode=require
      - CORS_ORIGIN=http://localhost:4501
    env_file:
      - .env.local
    volumes:
      - ./apps/api/src:/app/apps/api/src:ro
      - ./packages/shared/src:/app/packages/shared/src:ro
    # For MySQL tunnel access from host
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Web frontend with hot reloading
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web.local
    container_name: sporttia-zero-web-local
    restart: unless-stopped
    ports:
      - "4501:4501"
    environment:
      - NODE_ENV=development
      - VITE_APP_ENV=pre
      - PROXY_API_URL=http://api:4500
      - PROXY_ADMIN_URL=http://admin:4502
    volumes:
      - ./apps/web/src:/app/apps/web/src:ro
      - ./apps/web/public:/app/apps/web/public:ro
      - ./apps/web/vite.config.js:/app/apps/web/vite.config.js:ro
    depends_on:
      - api

  # Admin panel with hot reloading
  admin:
    build:
      context: .
      dockerfile: docker/Dockerfile.admin.local
    container_name: sporttia-zero-admin-local
    restart: unless-stopped
    ports:
      - "4502:4502"
    environment:
      - NODE_ENV=development
      - VITE_APP_ENV=pre
    volumes:
      - ./apps/admin/src:/app/apps/admin/src:ro
      - ./apps/admin/public:/app/apps/admin/public:ro
    depends_on:
      - api

# No local volumes needed - using Cloud SQL PostgreSQL
